
 // nodes from neo-mon and happy nodes
var nodesg = [ 
{"id": "http://seed1.aphelion-neo.com:10332", "ip": "18.194.0.22", "color": "red" }, //0
{"id": "http://seed2.aphelion-neo.com:10332", "ip": "18.196.141.225", "color": "red" },
{"id": "http://seed3.aphelion-neo.com:10332", "ip": "35.157.159.215", "color": "red" },
{"id": "http://seed4.aphelion-neo.com:10332", "ip": "35.157.89.64", "color": "red" },

{"id": "http://node2.ams2.bridgeprotocol.io:10332", "ip": "37.139.22.119", "color": "red" },
{"id": "http://node1.ams2.bridgeprotocol.io:10332", "ip": "198.211.127.188", "color": "red" },
{"id": "http://node1.nyc3.bridgeprotocol.io:10332", "ip": "165.227.186.72", "color": "red" },
{"id": "http://node2.nyc3.bridgeprotocol.io:10332", "ip": "159.65.244.191", "color": "red" },
{"id": "http://node1.sgp1.bridgeprotocol.io:10332", "ip": "206.189.94.221", "color": "red" },
{"id": "http://node2.sgp1.bridgeprotocol.io:10332", "ip": "206.189.152.158", "color": "red" },


{"id": "http://seed1.travala.com:10332", "ip": "52.74.91.157", "color": "red" },

{"id": "http://seed.neoeconomy.io:10332", "ip": "144.217.163.253", "color": "red" },

{"id": "https://seed1.switcheo.network:10331", "ip": "54.179.146.99", "color": "red", "val":20 },
{"id": "https://seed2.switcheo.network:10331", "ip": "52.76.83.78", "color": "red", "val":20 },
{"id": "https://seed3.switcheo.network:10331", "ip": "54.179.146.99", "color": "red", "val":20 },//!!
{"id": "https://seed4.switcheo.network:10331", "ip": "54.179.146.99", "color": "red", "val":20 },//!!
{"id": "https://seed5.switcheo.network:10331", "ip": "54.169.247.222", "color": "red", "val":20 },

{"id": "http://api.otcgo.cn:10332", "ip": "121.42.26.131", "color": "red" },

{"id": "https://seed0.cityofzion.io:443", "ip": "89.145.165.128", "color": "red" },
{"id": "https://seed1.cityofzion.io:443", "ip": "13.58.252.110", "color": "red" },
{"id": "https://seed2.cityofzion.io:443", "ip": "18.216.146.68", "color": "red" },
{"id": "https://seed3.cityofzion.io:443", "ip": "18.217.91.255", "color": "red" },
{"id": "https://seed4.cityofzion.io:443", "ip": "18.218.62.119", "color": "red" },
{"id": "https://seed5.cityofzion.io:443", "ip": "52.14.228.80", "color": "red" },
{"id": "https://seed6.cityofzion.io:443", "ip": "89.145.165.6", "color": "red" },
{"id": "https://seed7.cityofzion.io:443", "ip": "89.145.163.49", "color": "red" },
{"id": "https://seed8.cityofzion.io:443", "ip": "185.150.9.151", "color": "red" },
{"id": "https://seed9.cityofzion.io:443", "ip": "185.150.8.221", "color": "red" },

{"id": "https://seed1.redpulse.com:443", "ip": "35.158.117.74", "color": "red" },
{"id": "https://seed2.redpulse.com:443", "ip": "13.229.98.18", "color": "red" },

{"id": "https://seed1.spotcoin.com:10332", "ip": "18.194.110.81", "color": "red" },

{"id": "http://rustylogic.ddns.net:10332", "ip": "77.99.237.221", "color": "red" },

{"id": "http://seed1.ngd.network:10332", "ip": "47.254.28.42", "color": "red" },
{"id": "http://seed2.ngd.network:10332", "ip": "47.89.253.82", "color": "red" },
{"id": "http://seed3.ngd.network:10332", "ip": "47.52.168.73", "color": "red" },
{"id": "http://seed4.ngd.network:10332", "ip": "47.91.248.98", "color": "red" },
{"id": "http://seed5.ngd.network:10332", "ip": "47.97.73.20", "color": "red" },
{"id": "http://seed6.ngd.network:10332", "ip": "47.254.44.88", "color": "red" },
{"id": "http://seed7.ngd.network:10332", "ip": "47.254.83.14", "color": "red" },
{"id": "http://seed8.ngd.network:10332", "ip": "47.254.43.76", "color": "red" },
{"id": "http://seed9.ngd.network:10332", "ip": "47.91.225.117", "color": "red" },
{"id": "http://seed10.ngd.network:10332", "ip": "47.52.159.228", "color": "red"},

{"id": "https://seed1.neo.org:10331", "ip": "47.94.164.49", "color": "red" },
{"id": "http://seed2.neo.org:10332", "ip": "139.219.106.33", "color": "red" },
{"id": "http://seed3.neo.org:10332", "ip": "47.89.178.72", "color": "red" },
{"id": "http://seed4.neo.org:10332", "ip": "47.88.53.224", "color": "red" },
{"id": "http://seed5.neo.org:10332", "ip": "47.91.92.192", "color": "red" },

{"id": "https://seed1.red4sec.com:10332", "ip": "51.75.27.231", "color": "red" },

{"id": "http://node1.plutolo.gy:10332", "ip": "51.75.201.174", "color": "red" }, //48

{"id": "http://172.105.228.12:10332", "ip": "172.105.228.12", "color": "red", "loc":"Japan" },

{"id": "http://101.100.174.24:10332", "ip": "101.100.174.24", "color": "red" },

{"id": "http://108.252.121.18:10332", "ip": "108.252.121.18", "color": "red" },

{"id": "http://178.79.191.196:10332", "ip": "178.79.191.196", "color": "red" },

{"id": "http://47.254.64.251:10332", "ip": "47.254.64.251", "color": "red" },

{"id": "http://47.254.31.231:10332", "ip": "47.254.31.231", "color": "red" },

{"id": "http://35.236.147.196:10332", "ip": "35.236.147.196", "color": "red" },

{"id": "http://47.75.174.167:10332", "ip": "47.75.174.167", "color": "red" },

{"id": "http://103.41.107.195:10332", "ip": "103.41.107.195", "color": "red" }, //57

{"id": "http://114.215.30.71:10332", "ip": "114.215.30.71", "color": "red" },

{"id": "https://35.157.205.68:10332", "ip": "35.157.205.68", "color": "red" },

{"id": "http://23.99.143.74:10332", "ip": "23.99.143.74", "color": "red" },

{"id": "http://52.204.61.212:10332", "ip": "52.204.61.212", "color": "red" },

{"id": "http://13.230.32.107:10332", "ip": "13.230.32.107", "color": "red" },

{"id": "http://167.99.143.122:10331", "ip": "167.99.143.122", "color": "red" },

{"id": "http://159.100.255.130:10332", "ip": "159.100.255.130", "color": "red" },

{"id": "http://54.169.87.223:10332", "ip": "54.169.87.223", "color": "red" },

{"id": "http://185.195.255.164:10332", "ip": "185.195.255.164", "color": "red" },

{"id": "http://47.75.213.7:10332", "ip": "47.75.213.7", "color": "red" },

{"id": "http://13.236.186.168:10332", "ip": "13.236.186.168", "color": "red" },

{"id": "http://195.201.241.81:10332", "ip": "195.201.241.81", "color": "red" },//69

{"id": "http://47.52.132.248:10332", "ip": "47.52.132.248", "color": "red" },

{"id": "http://178.128.198.255:10332", "ip": "178.128.198.255", "color": "red" },

{"id": "https://52.28.40.92:10332", "ip": "52.28.40.92", "color": "red" },

{"id": "http://207.154.220.233:10332", "ip": "207.154.220.233", "color": "red" },

{"id": "http://120.79.24.81:10332", "ip": "120.79.24.81", "color": "red" },

{"id": "http://47.75.115.81:10332", "ip": "47.75.115.81", "color": "red" },

{"id": "http://139.162.45.250:10332", "ip": "139.162.45.250", "color": "red" },

{"id": "http://47.106.202.182:10332", "ip": "47.106.202.182", "color": "red" },

{"id": "http://139.129.235.173:10332", "ip": "139.129.235.173", "color": "red" },

{"id": "http://13.231.37.13:10332", "ip": "13.231.37.13", "color": "red" },

{"id": "http://47.75.143.59:10332", "ip": "47.75.143.59", "color": "red" },

{"id": "http://101.132.97.9:10332", "ip": "101.132.97.9", "color": "red" },

{"id": "http://106.14.212.33:10332", "ip": "106.14.212.33", "color": "red" },

{"id": "http://47.98.144.178:10332", "ip": "47.98.144.178", "color": "red" },

{"id": "http://35.194.176.211:10332", "ip": "35.194.176.211", "color": "red" },

{"id": "http://172.105.228.12:10332", "ip": "172.105.228.12", "color": "red" },

{"id": "http://seed1.cryptoholics.cc:10332", "ip": "91.121.221.54", "color": "red"}//86

];

var bestbl, ind, counter2, bestago, memp, d, peersx = [], blocks = [], mems = [], memsago = [], ips = [], dubl=[], linksx = [], pcou = [], diffx = [], bb, pp, memrms = 0,
txt = "SWITCH TO TABLE VIEW";

for (var i = 0; i < nodesg.length; ++i) {
  ips[i] = nodesg[i].ip;
}

function gpee(i) {// get peers 
  neo.node(nodesg[i].id).getPeers().then(function (result) {peersx[i] = result.connected; });
}
 function gb(i) {// get blocks
  neo.node(nodesg[i].id).getBlockCount().then(function (result) {blocks[i] = result; });
 }
function gm(i) {// get mempool
  neo.node(nodesg[i].id).getRawMemPool().then(function (result) {mems[i] = result.length; });
}  

// update mempool and bestblock
function runbest() {

for (var i = 0; i < nodesg.length; ++i) {
    gb(i);
    gpee(i);
    gm(i);
}	

setTimeout(calc, 4500) // time for get answers from nodes
  function calc() { 
   bb = 0; pp = 0; // count online nodes and edges
     //best block
       bestbl = Math.max.apply(null,(blocks.filter(el => el != undefined)));
       vm.bestb = bestbl - 1;

 // get links and color
    var index;
    linksx = [];
    for (var j = 0; j < nodesg.length; ++j) {
    if (blocks[j] != undefined) { ++bb;
    diffx[j] = blocks[j] - bestbl;
    (diffx[j] < -100) ? nodesg[j].color = 'OrangeRed' :
    (diffx[j] < -10) ? nodesg[j].color = 'DarkOrange' :  
    (diffx[j] < -3) ? nodesg[j].color = 'Yellow' : 
    (diffx[j]  <= 0) ? nodesg[j].color = 'Lime' : {};
    } else {diffx[j] = undefined; nodesg[j].color = 'Grey'}
    let pc = 0;
    try {
    for (var k of peersx[j]) { ++pc;
       index =  ips.indexOf(k.address);
        if (~index) { 
        if (blocks[index] == undefined) continue //detect unreachable nodes
            ++pp;
            linksx.push({
            source : nodesg[j].id,
            target : nodesg[index].id
             })
        }  
    }
    pcou[j] = pc;
    } catch(e) {continue}    
  };  

// template for mempool
      for (k = 0; k < nodesg.length; ++k) { 
          (mems[k] == memsago[k]) ? dubl[k] = 0 : dubl[k] = 1; // check bad nodes, mempool doesnt change
        }; 
      memsago = [].concat(mems);

// run, reset timer
    if (bestbl != bestago) {  
      if (bestago != undefined)  {counter2 = -1} else  {getl(); timerun(); setInterval(runbest, 5000)} // run timerun only one time
      bestago = bestbl;
    } 

    // avg rms mempool 
    var summ = dubl.reduce(function(sum, current) {
      return sum + current}, 0);

    if (summ > 1) {memp = 0 ; d = 0.001;} else {return};// if mempools didnt change
    
    for (var j = 0; j < nodesg.length; ++j) { // calculate avg  mem
          if (bestbl == blocks[j] && mems[j] != undefined && dubl[j] == 1) {++d;
            memp += mems[j] ** 2;
            } 
         }
         memrms = Math.pow(memp/d, 0.5).toFixed(0); 

         memp = 0 ; d = 0.001;
    for (var i = 0; i < nodesg.length; ++i) {
         if (bestbl == blocks[i] && mems[i] != undefined && dubl[i] == 1 && (mems[i] - memrms) < 100 ) {++d; // detect only correct nodes, 
          memp += mems[i] ** 2; 
          } 
        }  

      if (txt == "SWITCH TO GRAPH VIEW") {tprint()};
      document.getElementById('vertices').innerText = bb;	
      document.getElementById('edges').innerText = pp;
     
  }
}

//update time
async function timerun() { 
   
  var has, tim;
  ind = blocks.indexOf(bestbl);
  try {
  await neo.node(nodesg[ind].id).getBestBlockHash().then(function (result) {
    has = result	
  }); 
  await neo.node(nodesg[ind].id).getBlock(has, 1).then(function (result) {
    tim = result.time;
  }); 
} catch (e) {setTimeout(timerun, 5000); return}
  var x = moment().unix();
  var y = tim;
  ago = x - y;
  counter2 = ago;
  txt = "SWITCH TO TABLE VIEW";
  document.getElementById("tv").innerHTML = txt;

  setInterval(prmem, 1000);
  function prmem() {
    document.getElementById('lasttime').innerText =  (++counter2) ;
    (counter2 > 3600) ? document.getElementById('lasttime').style = 'color:red' : 
    (counter2 > 1800) ? document.getElementById('lasttime').style = 'color:orange' : 
    (counter2 > 300) ? document.getElementById('lasttime').style = 'color:yellow' :
    document.getElementById('lasttime').style = 'color:#fff';
    document.getElementById('bestblock').innerText =  bestbl-1;
    memrms = (Math.pow(memp/d, 0.5)).toFixed(0); 
    (memrms > 200 || counter2 > 1200) ? document.getElementById('aler').innerText = 'Be careful your transactions may be delayed!' :  document.getElementById('aler').innerText = '';
    (memrms > 500) ? document.getElementById('unconf').style = 'color:red' : 
    (memrms > 200) ? document.getElementById('unconf').style = 'color:orange' : 
    (memrms > 100) ? document.getElementById('unconf').style = 'color:yellow' :
    document.getElementById('unconf').style = 'color:lime';
    document.getElementById('unconf').innerText = memrms;	
  }
};


// create links array and draw graph
function getl () {
  // draw graph
  const gData = {
  nodes: nodesg,
  links: linksx
  };
  const elem = document.getElementById('dg');
  const Graph = ForceGraph3D()
      (elem)
      .graphData(gData)
      .width(850)
      .height(500)
      .backgroundColor('#212A3F')
     .nodeLabel('id')
      .nodeResolution(16)
     .linkWidth(1)
     .linkDirectionalParticles(10)
      .onNodeHover(node => elem.style.cursor = node ? 'pointer' : null)
      .onNodeClick(node => {
          // Aim at node from outside it
          const distance = 100;
          const distRatio = 1 + distance/Math.hypot(node.x, node.y, node.z);
          Graph.cameraPosition(
            { x: node.x * distRatio, y: node.y * distRatio, z: node.z * distRatio }, // new position
            node, // lookAt ({ x, y, z })
            3000  // ms transition duration
          );
        });
}


function tabelv() {
 
  if (txt == "SWITCH TO TABLE VIEW") { 
  txt = "SWITCH TO GRAPH VIEW"; 
  document.getElementById('dg').innerHTML = "";
  tprint();
 } else if (txt == "SWITCH TO GRAPH VIEW") {
 txt = "SWITCH TO TABLE VIEW";
  document.getElementById('tabv').innerHTML = "";
  getl();
 } else return;
  document.getElementById('tv').innerHTML = txt;
}
 
// print table
function tprint() {

document.getElementById('tabv').innerHTML = "";
let table = document.createElement('table');
let rows = nodesg.length;
let cols = 5;
let count = 0;

// sort table by height
var dif = [];
for (var key in diffx) {
  if (diffx[key] === undefined) {diffx[key] = - bestbl}
  dif.push([key, diffx[key]]); 
    }  
  dif.sort(function (a, b) { return b[1] - a[1] });


// create table
for (let i = -1; i < rows; i++) {
  let tr = document.createElement('tr');
  table.append(tr);
  tr.style = "width:850;";
  let k = dif[Math.abs(i)][0]; 

  if (~(nodesg[k].id).indexOf('switcheo')) {// set color for switcheo
     document.documentElement.style.setProperty('--mycol', nodesg[k].color);
       tr.style = "font-weight: bold; text-shadow: 0 0 20px var(--mycol);";
   }

  tr.style.color = nodesg[k].color // set color
  
// print rows
  for (let j = 0; j < cols; j++) {
    let td = document.createElement('td');

    if (i == -1) {
      tr.style = "color:#fff; ";
      (j == 0) ? td.innerHTML = "№" : 
      (j == 1) ? td.innerHTML = "NODE" : 
      (j == 2) ? td.innerHTML = "HEIGHT" : 
      (j == 3) ? td.innerHTML = "PEERS" : 
      td.innerHTML = "MEMPOOL";
      tr.append(td);
     }
     else {
        if (j == 0)  { td.innerHTML = count; td.style = "min-width :50px"}; 
         if (j == 1)  { td.innerHTML = nodesg[k].id;}; 
         if (j == 2) { td.style = "min-width :150px"; 
           (blocks[k] != undefined) ? td.innerHTML = (blocks[k]-1) + ' (' + diffx[k] + ')' : td.innerHTML = 'unreachable';
         }
         if (j == 3) { td.style = "min-width:100px"; 
           (peersx[k] != undefined) ? td.innerHTML = pcou[k] : td.innerHTML = '-';
         }
        if (j == 4) { td.style = "min-width:100px"; 
           (mems[k] != undefined) ? td.innerHTML =  mems[k] : td.innerHTML = '-';
         } 
        tr.append(td);
      }
  }
 ++count;
}

document.getElementById('tabv').append(table);
  
}


